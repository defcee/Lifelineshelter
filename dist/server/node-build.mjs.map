{"version":3,"file":"node-build.mjs","sources":["../../server/node-build.ts"],"sourcesContent":["// nodebuild.ts\r\nimport path from \"path\";\r\nimport express from \"express\";\r\nimport cors from \"cors\";\r\nimport nodemailer from \"nodemailer\";\r\n\r\n// ----------------------\r\n// Create Express Server\r\n// ----------------------\r\nfunction createServer() {\r\n  const app = express();\r\n\r\n  app.use(cors());\r\n  app.use(express.json());\r\n  app.use(express.urlencoded({ extended: true }));\r\n\r\n  // Ping / Health check\r\n  app.get(\"/api/ping\", (_req, res) => {\r\n    const ping = process.env.PING_MESSAGE ?? \"ping\";\r\n    res.json({ message: ping });\r\n  });\r\n\r\n  // Demo endpoint\r\n  app.get(\"/api/demo\", (_req, res) => {\r\n    res.json({ message: \"Hello from Express server\" });\r\n  });\r\n\r\n  // Admin login example\r\n  const ADMIN_USERNAME = process.env.ADMIN_USERNAME || \"admin\";\r\n  const ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || \"admin123\";\r\n\r\n  function generateToken(username: string) {\r\n    return Buffer.from(`${username}:${Date.now()}`).toString(\"base64\");\r\n  }\r\n\r\n  app.post(\"/api/admin/login\", (req, res) => {\r\n    const { username, password } = req.body;\r\n    if (!username || !password) {\r\n      return res.status(400).json({ success: false, message: \"Username and password required\" });\r\n    }\r\n\r\n    if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {\r\n      const token = generateToken(username);\r\n      return res.status(200).json({\r\n        success: true,\r\n        message: \"Login successful\",\r\n        token,\r\n        admin: {\r\n          username,\r\n          email: process.env.ADMIN_EMAIL\r\n        }\r\n      });\r\n    }\r\n\r\n    res.status(401).json({ success: false, message: \"Invalid username or password\" });\r\n  });\r\n\r\n  // Example: Contact / Get Involved endpoint\r\n  const EMAIL_TO = process.env.CONTACT_EMAIL || \"customerrepresentative@lifelineshelter.com\";\r\n\r\n  app.post(\"/api/get-involved\", async (req, res) => {\r\n    const { firstName, lastName, email, type, message } = req.body || {};\r\n\r\n    if (!firstName || !lastName || !email || !type || !message) {\r\n      return res.status(400).json({ message: \"All fields are required.\" });\r\n    }\r\n\r\n    try {\r\n      if (!process.env.SMTP_HOST || !process.env.SMTP_USER || !process.env.SMTP_PASS) {\r\n        console.warn(\"‚ö†Ô∏è SMTP not configured. Email may not be sent.\");\r\n        return res.status(200).json({ message: \"Your submission has been received. We will contact you soon.\" });\r\n      }\r\n\r\n      const transporter = nodemailer.createTransport({\r\n        host: process.env.SMTP_HOST,\r\n        port: Number(process.env.SMTP_PORT) || 465,\r\n        secure: true,\r\n        auth: {\r\n          user: process.env.SMTP_USER,\r\n          pass: process.env.SMTP_PASS\r\n        }\r\n      });\r\n\r\n      const mailOptions = {\r\n        from: `LifeLine Shelter <${process.env.SMTP_USER}>`,\r\n        to: EMAIL_TO,\r\n        subject: `[LifeLine] New ${type} Submission from ${firstName} ${lastName}`,\r\n        replyTo: email,\r\n        text: `Name: ${firstName} ${lastName}\\nEmail: ${email}\\nType: ${type}\\nMessage:\\n${message}`,\r\n        html: `<p><strong>Name:</strong> ${firstName} ${lastName}</p>\r\n               <p><strong>Email:</strong> ${email}</p>\r\n               <p><strong>Type:</strong> ${type}</p>\r\n               <p><strong>Message:</strong><br/>${message.replace(/\\n/g, \"<br/>\")}</p>`\r\n      };\r\n\r\n      await transporter.sendMail(mailOptions);\r\n\r\n      res.status(200).json({ message: \"Your message has been sent. Thank you!\" });\r\n    } catch (err) {\r\n      console.error(\"Failed to send email:\", err);\r\n      res.status(500).json({ message: \"Failed to send email. Please try again later.\" });\r\n    }\r\n  });\r\n\r\n  // Catch-all for unknown API endpoints (fix for Express 5 + path-to-regexp v8)\r\n  app.all(\"/api/:path*\", (_req, res) => {\r\n  res.status(404).json({ error: \"API endpoint not found\" });\r\n});\r\n\r\n  return app;\r\n}\r\n\r\n// ----------------------\r\n// Start Server\r\n// ----------------------\r\nconst app = createServer();\r\nconst port = process.env.PORT || 3000;\r\n\r\n// Serve built SPA files\r\nconst __dirname = import.meta.dirname;\r\nconst distPath = path.join(__dirname, \"../spa\");\r\napp.use(express.static(distPath));\r\n\r\n// SPA routing - send index.html for all non-API routes\r\napp.get(\"*\", (req, res) => {\r\n  if (req.path.startsWith(\"/api/\") || req.path.startsWith(\"/health\")) {\r\n    return res.status(404).json({ error: \"API endpoint not found\" });\r\n  }\r\n  res.sendFile(path.join(distPath, \"index.html\"));\r\n});\r\n\r\napp.listen(port, () => {\r\n  console.log(`üöÄ Fusion Starter server running on port ${port}`);\r\n  console.log(`üì± Frontend: http://localhost:${port}`);\r\n  console.log(`üîß API: http://localhost:${port}/api`);\r\n});\r\n\r\n// Graceful shutdown\r\nprocess.on(\"SIGTERM\", () => {\r\n  console.log(\"üõë Received SIGTERM, shutting down gracefully\");\r\n  process.exit(0);\r\n});\r\n\r\nprocess.on(\"SIGINT\", () => {\r\n  console.log(\"üõë Received SIGINT, shutting down gracefully\");\r\n  process.exit(0);\r\n});\r\n"],"names":["app","__dirname"],"mappings":"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"}