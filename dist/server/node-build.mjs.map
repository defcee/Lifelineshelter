{"version":3,"file":"node-build.mjs","sources":["../../server/node-build.ts"],"sourcesContent":["import path from \"path\";\r\nimport express, { Request, Response } from \"express\";\r\nimport cors from \"cors\";\r\nimport nodemailer from \"nodemailer\";\r\n\r\n// ----------------------\r\n// Environment variables\r\n// ----------------------\r\nconst ADMIN_USERNAME = process.env.ADMIN_USERNAME || \"admin\";\r\nconst ADMIN_PASSWORD = process.env.ADMIN_PASSWORD || \"admin123\";\r\nconst ADMIN_EMAIL = process.env.ADMIN_EMAIL || \"admin@lifelineshelter.com\";\r\nconst CONTACT_EMAIL = process.env.CONTACT_EMAIL || \"customerrepresentative@lifelineshelter.com\";\r\nconst SMTP_HOST = process.env.SMTP_HOST || \"mail.lifelineshelter.com\";\r\nconst SMTP_PORT = Number(process.env.SMTP_PORT) || 465;\r\nconst SMTP_USER = process.env.SMTP_USER || \"customerrepresentative@lifelineshelter.com\";\r\nconst SMTP_PASS = process.env.SMTP_PASS || \"your_email_password_here\";\r\nconst PORT = Number(process.env.PORT) || 3000;\r\nconst PING_MESSAGE = process.env.PING_MESSAGE || \"ping pong\";\r\n\r\n// ----------------------\r\n// Create Express Server\r\n// ----------------------\r\nfunction createServer() {\r\n  const app = express();\r\n\r\n  app.use(cors());\r\n  app.use(express.json());\r\n  app.use(express.urlencoded({ extended: true }));\r\n\r\n  // ----------------------\r\n  // API Routes\r\n  // ----------------------\r\n\r\n  // Health check\r\n  app.get(\"/api/ping\", (_req: Request, res: Response) => {\r\n    res.json({ message: PING_MESSAGE });\r\n  });\r\n\r\n  // Demo endpoint\r\n  app.get(\"/api/demo\", (_req: Request, res: Response) => {\r\n    res.json({ message: \"Hello from Express server\" });\r\n  });\r\n\r\n  // Admin login\r\n  function generateToken(username: string) {\r\n    return Buffer.from(`${username}:${Date.now()}`).toString(\"base64\");\r\n  }\r\n\r\n  app.post(\"/api/admin/login\", (req: Request, res: Response) => {\r\n    const { username, password } = req.body;\r\n    if (!username || !password) {\r\n      return res.status(400).json({ success: false, message: \"Username and password required\" });\r\n    }\r\n    if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {\r\n      const token = generateToken(username);\r\n      return res.status(200).json({\r\n        success: true,\r\n        message: \"Login successful\",\r\n        token,\r\n        admin: { username, email: ADMIN_EMAIL }\r\n      });\r\n    }\r\n    res.status(401).json({ success: false, message: \"Invalid username or password\" });\r\n  });\r\n\r\n  // Contact / Get Involved\r\n  app.post(\"/api/get-involved\", async (req: Request, res: Response) => {\r\n    const { firstName, lastName, email, type, message } = req.body || {};\r\n    if (!firstName || !lastName || !email || !type || !message) {\r\n      return res.status(400).json({ message: \"All fields are required.\" });\r\n    }\r\n\r\n    try {\r\n      if (!SMTP_HOST || !SMTP_USER || !SMTP_PASS) {\r\n        console.warn(\"‚ö†Ô∏è SMTP not configured. Email may not be sent.\");\r\n        return res.status(200).json({ message: \"Your submission has been received. We will contact you soon.\" });\r\n      }\r\n\r\n      const transporter = nodemailer.createTransport({\r\n        host: SMTP_HOST,\r\n        port: SMTP_PORT,\r\n        secure: true,\r\n        auth: { user: SMTP_USER, pass: SMTP_PASS }\r\n      });\r\n\r\n      const mailOptions = {\r\n        from: `LifeLine Shelter <${SMTP_USER}>`,\r\n        to: CONTACT_EMAIL,\r\n        subject: `[LifeLine] New ${type} Submission from ${firstName} ${lastName}`,\r\n        replyTo: email,\r\n        text: `Name: ${firstName} ${lastName}\\nEmail: ${email}\\nType: ${type}\\nMessage:\\n${message}`,\r\n        html: `<p><strong>Name:</strong> ${firstName} ${lastName}</p>\r\n               <p><strong>Email:</strong> ${email}</p>\r\n               <p><strong>Type:</strong> ${type}</p>\r\n               <p><strong>Message:</strong><br/>${message.replace(/\\n/g, \"<br/>\")}</p>`\r\n      };\r\n\r\n      await transporter.sendMail(mailOptions);\r\n      res.status(200).json({ message: \"Your message has been sent. Thank you!\" });\r\n    } catch (err) {\r\n      console.error(\"Failed to send email:\", err);\r\n      res.status(500).json({ message: \"Failed to send email. Please try again later.\" });\r\n    }\r\n  });\r\n\r\n  // Catch-all for unknown API endpoints\r\n  app.all(\"/api/:splat*\", (_req: Request, res: Response) => {\r\n    res.status(404).json({ error: \"API endpoint not found\" });\r\n  });\r\n\r\n  return app;\r\n}\r\n\r\n// ----------------------\r\n// Start Server\r\n// ----------------------\r\nconst app = createServer();\r\n\r\n// ----------------------\n// Serve SPA\n// ----------------------\n// Resolve SPA path relative to the directory where node-build.mjs is running\nconst spaPath = path.resolve(__dirname, \"../spa\");\napp.use(express.static(spaPath));\n\n// SPA routing: serve index.html for all non-API routes\napp.get(\"*\", (req: Request, res: Response) => {\n  if (req.path.startsWith(\"/api/\") || req.path.startsWith(\"/health\")) {\n    return res.status(404).json({ error: \"API endpoint not found\" });\n  }\n  res.sendFile(path.join(spaPath, \"index.html\"), (err) => {\n    if (err) {\n      console.error(`Error serving index.html from ${spaPath}:`, err.message);\n      res.status(500).json({ error: \"Failed to serve index.html\" });\n    }\n  });\n});\r\n\r\n// ----------------------\r\n// Start listening\r\n// ----------------------\r\napp.listen(PORT, () => {\r\n  console.log(`üöÄ Server running on port ${PORT}`);\r\n  console.log(`üì± Frontend available at /server/spa/`);\r\n  console.log(`üîß API available at /api/`);\r\n});\r\n\r\n// ----------------------\r\n// Graceful shutdown\r\n// ----------------------\r\nprocess.on(\"SIGTERM\", () => process.exit(0));\r\nprocess.on(\"SIGINT\", () => process.exit(0));\n"],"names":["app"],"mappings":"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"}